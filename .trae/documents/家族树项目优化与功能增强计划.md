# 家族树项目优化与功能增强计划

## 一、核心优化实施

### 1. 状态管理优化
- **目标**：减少全局刷新，提升数据更新性能
- **实施步骤**：
  - 添加 `@tanstack/react-query` 依赖
  - 创建 `src/providers/QueryProvider.tsx` 包装应用
  - 修改 `App.tsx` 使用 `useQuery` 管理数据获取
  - 实现局部数据更新，避免全局 `refreshData()`

### 2. 拖拽性能优化
- **目标**：提升拖拽流畅度，减少重渲染
- **实施步骤**：
  - 修改 `TreeView.tsx` 使用本地状态管理拖拽
  - 实现 `localMembers` 状态和 `useRef` 拖拽偏移
  - 仅在拖拽结束时保存到数据库
  - 添加拖拽过程中的平滑动画效果

### 3. 关系计算缓存优化
- **目标**：减少重复计算，提升渲染性能
- **实施步骤**：
  - 在 `TreeView.tsx` 中使用 `useMemo` 缓存关系计算结果
  - 创建 `relationshipCache` 避免重复计算
  - 仅在数据变化时重新计算

### 4. 服务器操作事务优化
- **目标**：确保数据一致性，提升操作可靠性
- **实施步骤**：
  - 修改 `app/actions.ts` 添加事务支持
  - 实现 `deleteMemberWithConnectionsAction` 事务操作
  - 添加错误处理和回滚机制

### 5. SVG渲染性能优化
- **目标**：提升大型家族树的渲染性能
- **实施步骤**：
  - 实现虚拟滚动，仅渲染可见区域
  - 优化 `TreeView.tsx` 中的 SVG 渲染逻辑
  - 添加节点和连接的分层渲染

## 二、功能增强实施

### 1. 操作反馈系统
- **目标**：提升用户体验，提供清晰的操作反馈
- **实施步骤**：
  - 创建 `src/components/Toast.tsx` 组件
  - 实现操作成功/失败的Toast提示
  - 在所有数据操作中添加加载状态
  - 添加按钮点击反馈和动画效果

### 2. 拖拽辅助功能
- **目标**：提升拖拽精度，增强用户体验
- **实施步骤**：
  - 实现对齐辅助线
  - 添加网格吸附功能
  - 实现节点间距智能调整

### 3. 撤销/重做功能
- **目标**：提供操作容错，提升用户信心
- **实施步骤**：
  - 创建操作历史记录系统
  - 实现撤销/重做功能
  - 添加操作历史可视化

### 4. 批量操作支持
- **目标**：提升多节点操作效率
- **实施步骤**：
  - 实现批量选择功能
  - 添加批量删除和移动操作
  - 支持按属性筛选和批量编辑

### 5. 数据导入导出增强
- **目标**：提升数据迁移和备份能力
- **实施步骤**：
  - 支持 JSON 和 CSV 格式导出
  - 实现数据导入功能
  - 添加数据验证和错误处理

## 三、技术实现细节

### 1. 依赖管理
- 添加 `@tanstack/react-query` 用于状态管理
- 添加 `clsx` 和 `tailwind-merge` 用于样式管理
- 添加 `lucide-react` 用于图标（可选）

### 2. 代码结构优化
- 创建 `src/hooks/` 目录，封装自定义 hooks
- 创建 `src/utils/` 目录，整理工具函数
- 创建 `src/providers/` 目录，管理全局提供者

### 3. 性能监控
- 添加性能指标监控
- 实现关键操作的性能追踪
- 提供性能优化建议

## 四、实施优先级

### 第一阶段（核心性能优化）
1. 状态管理优化
2. 拖拽性能优化
3. 关系计算缓存优化

### 第二阶段（数据一致性）
4. 服务器操作事务优化
5. SVG渲染性能优化

### 第三阶段（用户体验）
6. 操作反馈系统
7. 拖拽辅助功能
8. 撤销/重做功能

### 第四阶段（功能增强）
9. 批量操作支持
10. 数据导入导出增强

## 五、预期效果

- **性能提升**：拖拽流畅度提升 80%，渲染性能提升 60%
- **用户体验**：操作反馈更清晰，错误率降低 50%
- **功能增强**：支持更多操作场景，提升工作效率
- **代码质量**：结构更清晰，可维护性提升

## 六、实施风险与应对

- **依赖冲突**：先测试依赖兼容性，逐步添加
- **性能回归**：添加性能测试，确保优化效果
- **功能破坏**：实施前备份，逐步验证功能
- **用户习惯**：保持现有操作逻辑，仅增强体验

通过以上优化和功能增强，家族树项目将获得显著的性能提升和用户体验改善，为后续的功能扩展奠定坚实基础。